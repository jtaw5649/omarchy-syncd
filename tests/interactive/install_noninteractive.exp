#!/usr/bin/env expect

set timeout 60
set project_root [lindex $argv 0]

spawn bash -lc "cd $project_root && OMARCHY_SYNCD_NO_FLOAT=1 OMARCHY_SYNCD_NON_INTERACTIVE=1 OMARCHY_SYNCD_INSTALL_ARGS='--bundle core_desktop' ./install.sh"
expect {
  -re "Saved selection" {}
}
expect {
  -re "Press any key to close" {}
}
send "\r"
expect eof

set config_path [file join $env(HOME) ".config" "omarchy-syncd" "config.toml"]
if {![file exists $config_path]} {
  puts stderr "config not created at $config_path"
  exit 1
}
set fh [open $config_path r]
set config_contents [read $fh]
close $fh
if {[string first "core_desktop" $config_contents] == -1} {
  puts stderr "expected core_desktop bundle in config"
  exit 1
}
